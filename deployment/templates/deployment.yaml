{{- define "vjcms.appEnv" -}}
{{- if .Values.database.secret }}
- name: POSTGRES_PASSWORD
  valueFrom:
    secretKeyRef:
      name: {{ .Values.database.secret }}
      key: password
      optional: false
{{- end -}}
{{- if .Values.django.secret }}
- name: DJANGO_SECRET_KEY
  valueFrom:
    secretKeyRef:
      name: {{ .Values.django.secret }}
      key: secret
      optional: false
{{- end -}}
{{- if .Values.storage.secret }}
- name: STORAGE_ACCOUNT_KEY
  valueFrom:
    secretKeyRef:
      name: {{ .Values.storage.secret }}
      key: key
      optional: true
{{- end -}}
{{- end -}}
{{- define "vjcms.envFrom" -}}
- configMapRef:
    name: django-env
{{- end -}}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "vjcms.fullname" . }}
  labels:
    {{- include "vjcms.labels" . | nindent 4 }}
spec:
  replicas: 1
  selector:
    matchLabels:
      {{- include "vjcms.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "vjcms.selectorLabels" . | nindent 8 }}
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/django-env.yaml") . | sha256sum }}
        rollme: {{ randAlphaNum 5 | quote }}
    spec:
      containers:
      - name: {{ include "vjcms.name" . }}
        image: {{ include "vjcms.image" . }}
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        ports:
        - name: http
          containerPort: {{ .Values.gunicorn.listenPort }}
          protocol: TCP
        args:
        - gunicorn
        - {{ .Values.gunicorn.application }}
        - --bind
        - 0.0.0.0:{{ .Values.gunicorn.listenPort }}
        - --workers={{ .Values.gunicorn.workers }}
        envFrom:
        {{- include "vjcms.envFrom" . | nindent 8 }}
        env:
        {{- include "vjcms.appEnv" . | nindent 8 }}
